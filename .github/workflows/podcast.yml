name: Weekly AI Executive Brief

on:
  # Manual button (if/when GitHub shows it)
  workflow_dispatch: {}

  # Scheduled every Monday 08:05 Mountain Time (14:05 UTC)
  schedule:
    - cron: '5 14 * * 1'

  # Safety: allow a push to a single file to force a run whenever you want
  push:
    paths:
      - '.github/force-run'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Generate audio + transcript (.mp3 and .txt in audio/)
      - name: Generate MP3 + transcript
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          # If you stored the voice id as a secret, uncomment next line:
          # ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
        run: |
          python scripts/generate_brief.py

      # Update RSS feed to latest audio
      - name: Update feed.xml
        run: |
          python scripts/update_feed.py \
            --repo-url "https://kyledeguire.github.io/ai-news-audio-feed" \
            --audio-dir "audio" \
            --feed "feed.xml" \
            --show-title "AI News Weekly – Executive Briefing" \
            --show-description "Weekly AI news analysis and strategic insights for business leaders" \
            --language "en-us"

      # Commit changes (audio/*.mp3, audio/*.txt, feed.xml)
      - name: Commit audio + feed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: weekly brief – audio + transcript + feed"
          file_pattern: |
            audio/*.mp3
            audio/*.txt
            feed.xml

      # Find latest transcript (guard if none exists)
      - name: Find latest transcript & build email meta
        id: latest
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          FILES=(audio/*.txt)
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No transcript found in audio/. Exiting early."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LATEST_TXT=$(ls -t audio/*.txt | head -n1)
          LATEST_MP3="${LATEST_TXT%.txt}.mp3"
          STAMP="${LATEST_TXT##*_}"      # e.g., 20250915.txt
          STAMP="${STAMP%.txt}"          # 20250915

          # Build a readable date in bash (Ubuntu runner supports GNU date)
          READABLE_DATE=$(date -d "${STAMP:0:4}-${STAMP:4:2}-${STAMP:6:2}" +"%A, %B %d, %Y")

          {
            echo "txt=${LATEST_TXT}"
            echo "mp3file=$(basename "$LATEST_MP3")"
            echo "date_readable=${READABLE_DATE}"
            echo "found=true"
          } >> "$GITHUB_OUTPUT"

      # Read transcript into env (safe delimiter; only if found)
      - name: Read transcript into env
        if: steps.latest.outputs.found == 'true'
        shell: bash
        run: |
          set -euo pipefail
          # Generate a unique delimiter to avoid "Matching delimiter not found"
          DELIM=$(python - <<'PY'
import secrets
print(secrets.token_hex(16))
PY
)
          {
            echo "TRANSCRIPT<<${DELIM}"
            cat "${{ steps.latest.outputs.txt }}"
            echo "${DELIM}"
          } >> "$GITHUB_ENV"

      # Email the transcript (attachment + body; only if found)
      - name: Email transcript
        if: steps.latest.outputs.found == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          # If you use port 465 (SSL): keep secure: true
          # If you use port 587 (TLS): set secure: false and add starttls: true
          secure: true
          # starttls: true
          subject: "AI Executive Brief transcript — ${{ steps.latest.outputs.date_readable }}"
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}
          attachments: ${{ steps.latest.outputs.txt }}
          body: |
            New episode transcript attached.

            Episode date: ${{ steps.latest.outputs.date_readable }}
            Feed: https://kyledeguire.github.io/ai-news-audio-feed/feed.xml
            Audio: https://kyledeguire.github.io/ai-news-audio-feed/audio/${{ steps.latest.outputs.mp3file }}

            ---- Transcript ----
            ${{ env.TRANSCRIPT }}
